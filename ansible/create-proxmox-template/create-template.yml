---
- name: Create Ubuntu 24.04 Cloud-init Template on all Proxmox nodes
  hosts: proxmox_nodes
  gather_facts: yes
  
  tasks:
    - name: Set template ID based on node
      set_fact:
        template_id: "{{ lookup('vars', 'template_id_' + inventory_hostname) }}"

    - name: Check if libguestfs-tools is installed
      command: which virt-customize
      register: virt_customize_check
      failed_when: false
      changed_when: false

    - name: Install libguestfs-tools if not present
      apt:
        name: libguestfs-tools
        state: present
        update_cache: yes
      when: virt_customize_check.rc != 0

    - name: Check if template already exists
      shell: qm list | grep -w "{{ template_id }}"
      register: template_exists
      failed_when: false
      changed_when: false

    - name: Delete existing template if it exists
      command: qm destroy {{ template_id }}
      when: template_exists.rc == 0
      register: template_deleted

    - name: Wait a moment after deletion
      pause:
        seconds: 2
      when: template_deleted.changed

    - name: Create ISO directory if it doesn't exist
      file:
        path: "{{ iso_dir }}"
        state: directory
        mode: '0755'

    - name: Check if cloud image already downloaded
      stat:
        path: "{{ iso_dir }}/{{ cloud_image_file }}"
      register: cloud_image_stat

    - name: Download Ubuntu 24.04 cloud image
      get_url:
        url: "{{ cloud_image_url }}"
        dest: "{{ iso_dir }}/{{ cloud_image_file }}"
        mode: '0644'
      when: not cloud_image_stat.stat.exists

    - name: Create VM template
      command: >
        qm create {{ template_id }}
        --name {{ template_name }}
        --cores 2
        --memory 2048
        --net0 virtio,bridge=vmbr0
      register: vm_created

    - name: Import disk to VM
      command: >
        qm importdisk {{ template_id }}
        {{ iso_dir }}/{{ cloud_image_file }}
        {{ storage }}
      when: vm_created.changed

    - name: Configure SCSI controller and disk
      command: >
        qm set {{ template_id }}
        --scsihw virtio-scsi-single
        --scsi0 {{ storage }}:vm-{{ template_id }}-disk-0
      when: vm_created.changed

    - name: Add cloud-init drive
      command: qm set {{ template_id }} --ide2 {{ storage }}:cloudinit
      when: vm_created.changed

    - name: Configure boot settings
      command: qm set {{ template_id }} --boot c --bootdisk scsi0
      when: vm_created.changed

    - name: Configure serial console
      command: qm set {{ template_id }} --serial0 socket
      when: vm_created.changed

    - name: Enable QEMU Guest Agent
      command: qm set {{ template_id }} --agent enabled=1
      when: vm_created.changed

    - name: Customize disk image - SSH and basic system settings
      command: >
        virt-customize -a /dev/pve/vm-{{ template_id }}-disk-0
        --run-command "sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config"
        --run-command "sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config"
        --run-command "sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config.d/60-cloudimg-settings.conf || true"
        --run-command "sed -i '/^[ -]*update_etc_hosts/d' /etc/cloud/cloud.cfg"
        --run-command "swapoff -a 2>/dev/null || true"
        --run-command "sed -i '/ swap / s/^/#/' /etc/fstab"
        --run-command "mkdir -p /etc/modules-load.d"
        --run-command "echo 'overlay' > /etc/modules-load.d/k8s.conf"
        --run-command "echo 'br_netfilter' >> /etc/modules-load.d/k8s.conf"
        --run-command "mkdir -p /etc/sysctl.d"
        --run-command "echo 'net.bridge.bridge-nf-call-iptables = 1' > /etc/sysctl.d/k8s.conf"
        --run-command "echo 'net.bridge.bridge-nf-call-ip6tables = 1' >> /etc/sysctl.d/k8s.conf"
        --run-command "echo 'net.ipv4.ip_forward = 1' >> /etc/sysctl.d/k8s.conf"
        --timezone Asia/Tokyo
      when: vm_created.changed

    - name: Convert VM to template
      command: qm template {{ template_id }}
      when: vm_created.changed

    - name: Verify template creation
      shell: qm list | grep -w "{{ template_id }}"
      register: final_check
      changed_when: false

    - name: Display template status
      debug:
        msg: "Template {{ template_name }} (ID: {{ template_id }}) successfully created on {{ inventory_hostname }}"
      when: final_check.rc == 0
